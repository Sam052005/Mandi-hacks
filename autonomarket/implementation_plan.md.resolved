# AutonoMarket — Final Implementation Plan

> **Agentic E-Commerce with Human Governance**
> Cerebrum SDK + Python LangGraph + Weilchain WUSD

---

## Executive Summary

AutonoMarket is a **4-layer autonomous e-commerce marketplace** where AI agents handle product discovery, price negotiation, and transaction execution, while critical decisions escalate to humans via Cerebrum's human-in-the-loop system. Payments settle on Weilchain using WUSD stablecoin.

This plan is organized into **7 phases**, each producing a **runnable, demo-able increment**.

---

## System Architecture

```mermaid
graph TB
    subgraph "Layer 4 — Frontend"
        UI["Next.js Web App"]
    end

    subgraph "Layer 2 — Agent Engine"
        ORCH["LangGraph Orchestrator"]
        DA["Discovery Agent"]
        NA["Negotiation Agent"]
        RA["Routing Agent"]
        REC["Recommendation Agent"]
        AUDIT["Audit Logger"]
    end

    subgraph "Layer 1 — Governance"
        CER["Cerebrum Gateway"]
        HITL["Human-in-the-Loop"]
        QUEUE["Redis Approval Queue"]
    end

    subgraph "Layer 3 — Settlement"
        ESC["Escrow Contract"]
        REP["Reputation Contract"]
        AUD["Audit Contract"]
        WUSD["WUSD / MockToken"]
    end

    subgraph "Infrastructure"
        API["FastAPI Backend"]
        DB["PostgreSQL + Redis"]
        WS["WebSocket Server"]
    end

    UI --> API
    API --> ORCH
    ORCH --> DA & NA & RA & REC
    ORCH --> AUDIT
    ORCH --> CER
    CER --> HITL
    CER --> QUEUE
    HITL --> WS --> UI
    CER --> ESC & REP & AUD
    ESC --> WUSD
```

---

## Technology Decisions

| Layer | Technology | Rationale |
|-------|-----------|-----------|
| **Frontend** | Next.js 15 + TypeScript | SSR, API routes, rich ecosystem |
| **Backend API** | FastAPI (Python) | Async, type-safe, LangChain native |
| **Agent Engine** | LangGraph + LangChain | HITL interrupts, checkpoints, state graphs |
| **Governance** | Cerebrum SDK (Python) | Agentic orchestration with HITL |
| **Smart Contracts** | Solidity (EVM-compatible) | Escrow, Reputation, Audit contracts |
| **Database** | PostgreSQL + Redis | Relational data + caching/queues |
| **Real-time** | WebSockets | Approval notifications, live agent updates |
| **Auth** | JWT (python-jose + passlib) | Stateless token auth |

---

## Directory Structure

```
d:\IIT_Mandi\autonomarket\
├── frontend/                    # Next.js 15 app
│   ├── src/
│   │   ├── app/                 # App router pages
│   │   │   ├── (shop)/          # Product listing, detail, cart, checkout
│   │   │   ├── (dashboard)/     # Approval dashboard, audit viewer
│   │   │   └── (auth)/          # Auth pages
│   │   ├── components/
│   │   │   ├── shop/            # ProductCard, SearchBar
│   │   │   ├── approval/        # ApprovalCard, ApprovalActions
│   │   │   ├── audit/           # TransactionTrail, SignatureVerifier
│   │   │   ├── agent/           # AgentTracePanel, DecisionTimeline
│   │   │   └── ui/              # Shared primitives (Button, Card, etc.)
│   │   ├── lib/                 # Utilities, SDK wrappers
│   │   ├── hooks/               # Custom React hooks
│   │   ├── stores/              # Zustand state management
│   │   └── styles/              # CSS modules, design tokens
│   └── public/
│
├── backend/                     # FastAPI Python server
│   ├── app/
│   │   ├── main.py
│   │   ├── api/
│   │   │   ├── deps.py
│   │   │   └── routes/
│   │   │       ├── auth.py
│   │   │       ├── products.py
│   │   │       ├── orders.py
│   │   │       ├── approvals.py
│   │   │       ├── agent.py
│   │   │       └── websocket.py
│   │   ├── agents/
│   │   │   ├── state.py
│   │   │   ├── discovery.py
│   │   │   ├── negotiation.py
│   │   │   ├── routing.py
│   │   │   ├── recommendation.py
│   │   │   └── orchestrator.py
│   │   ├── cerebrum/
│   │   │   ├── gateway.py
│   │   │   ├── queue.py
│   │   │   └── notifications.py
│   │   ├── audit/
│   │   │   ├── logger.py
│   │   │   └── chain.py
│   │   ├── models/
│   │   │   ├── user.py
│   │   │   ├── product.py
│   │   │   ├── order.py
│   │   │   └── approval.py
│   │   ├── services/
│   │   │   ├── user_service.py
│   │   │   ├── product_service.py
│   │   │   ├── order_service.py
│   │   │   ├── settlement.py
│   │   │   └── reputation.py
│   │   └── core/
│   │       ├── config.py
│   │       ├── database.py
│   │       └── security.py
│   ├── tests/
│   └── requirements.txt
│
├── contracts/                   # Solidity smart contracts
│   ├── src/
│   │   ├── Escrow.sol
│   │   ├── Reputation.sol
│   │   ├── AuditLog.sol
│   │   └── MockToken.sol
│   ├── scripts/deploy.js
│   └── test/
│
├── docs/
│   ├── ARCHITECTURE.md
│   ├── AGENT_DESIGN.md
│   └── API.md
├── .env.example
├── README.md
└── docker-compose.yml
```

---

## Phase Breakdown

---

### Phase 1 — Foundation & Core Backend

**Goal:** Runnable backend with database, auth, product catalog, and all models.

| File | Purpose |
|------|---------|
| `autonomarket/` root | Folder scaffold, `docker-compose.yml` stub |
| `backend/venv/` | Python virtualenv |
| `backend/requirements.txt` | All Python deps |
| `.env.example` | Placeholder env vars |
| `backend/app/main.py` | FastAPI app entry, CORS, lifespan, OpenAPI |
| `backend/app/core/config.py` | Pydantic BaseSettings reading `.env` |
| `backend/app/core/database.py` | Async SQLAlchemy engine + session |
| `backend/app/core/security.py` | JWT creation/verification, password hashing |
| `backend/app/models/user.py` | User model with wallet address |
| `backend/app/models/product.py` | Product, Category, Supplier |
| `backend/app/models/order.py` | Order, OrderItem, OrderStatus enum |
| `backend/app/models/approval.py` | ApprovalRequest, ApprovalStatus, timeout_at |
| `backend/app/api/routes/auth.py` | Register, login, token refresh |
| `backend/app/api/routes/products.py` | CRUD products, search, filter |
| `backend/app/api/routes/orders.py` | Create order, list orders, order detail |
| `backend/app/services/` | Business logic (user, product, order services) |

**Verify:** `uvicorn app.main:app` → OpenAPI docs at `/docs`

---

### Phase 2 — AI Agent Engine

**Goal:** LangGraph orchestrator with 4 agents executing the full purchase workflow.

| File | Purpose |
|------|---------|
| `backend/app/agents/state.py` | `AgentState` TypedDict shared state |
| `backend/app/agents/discovery.py` | Queries product DB, ranks by relevance |
| `backend/app/agents/negotiation.py` | Discount rules, simulates supplier negotiation |
| `backend/app/agents/routing.py` | Selects payment method + shipping option |
| `backend/app/agents/recommendation.py` | Collaborative filtering on purchase history |
| `backend/app/agents/orchestrator.py` | `StateGraph` with conditional edges |
| `backend/app/api/routes/agent.py` | `POST /api/agent/query` endpoint |

**LangGraph Workflow:**

```mermaid
graph LR
    A["User Query"] --> B["Discovery"]
    B --> C["Negotiation"]
    C --> D["Routing"]
    D --> E{"Value > Threshold?"}
    E -->|Yes| F["Cerebrum Gate"]
    E -->|No| G["Auto-Execute"]
    F --> H{"Human Decision"}
    H -->|Approve| G
    H -->|Reject| I["Cancel Order"]
    G --> J["Settlement"]
```

Uses `interrupt_before` on Cerebrum Gate node. Human decisions resume via `Command`.

**API Returns:** plan, steps, selected product, final price, confidence.

**Verify:** `POST /api/agent/query` with `"wireless headphones"` → structured response.

---

### Phase 3 — Cerebrum Governance & HITL

**Goal:** Human-in-the-loop approval system with real-time WebSocket notifications.

| File | Purpose |
|------|---------|
| `backend/app/cerebrum/gateway.py` | Threshold evaluation, risk scoring, escalation |
| `backend/app/cerebrum/queue.py` | Redis approval queue, 24h timeout auto-reject |
| `backend/app/cerebrum/notifications.py` | WebSocket push to approver dashboard |
| `backend/app/api/routes/approvals.py` | List pending, approve/reject, escalate |
| `backend/app/api/routes/websocket.py` | WebSocket endpoint for real-time notifications |

**Tiered Autonomy Rules:**

| Condition | Action |
|-----------|--------|
| `value < ₹5,000` AND trusted supplier | **Auto-approve** |
| `value ≥ ₹5,000` | **Pause → Human approval** |
| New supplier (first transaction) | **Pause → Human verification** |
| Dispute raised | **Pause → Human mediation** |
| Anomaly detected (spending spike) | **Emergency stop** |

**Verify:** Create order > ₹5,000 → approval request created → approve → order proceeds.

---

### Phase 4 — Audit Logging System

**Goal:** Tamper-evident audit trail with signed actions and Merkle roots.

| File | Purpose |
|------|---------|
| `backend/app/audit/logger.py` | HMAC-SHA256 signature per agent action |
| `backend/app/audit/chain.py` | Batch logs, compute Merkle root, persist to DB |

Each log entry: `timestamp`, `action`, `inputs`, `outputs`, `reasoning`, `signature`.

**Verify:** Each agent action appears in audit DB with valid signature.

---

### Phase 5 — Smart Contracts

**Goal:** Deployed escrow, reputation, and audit contracts (Hardhat local or testnet).

| File | Purpose |
|------|---------|
| `contracts/src/Escrow.sol` | Hold funds, release on delivery, refund on dispute |
| `contracts/src/Reputation.sol` | Immutable supplier/customer ratings (1-5 stars) |
| `contracts/src/AuditLog.sol` | Store Merkle roots from backend |
| `contracts/src/MockToken.sol` | ERC-20 mock for testing payments |
| `contracts/scripts/deploy.js` | Hardhat deployment script |
| `contracts/test/` | Test files per contract |
| `backend/app/services/settlement.py` | Orchestrates escrow deposit → delivery → release |
| `backend/app/services/reputation.py` | Updates on-chain reputation after order completion |

**Verify:** `npx hardhat test` → all contract tests pass.

---

### Phase 6 — Frontend Application

**Goal:** Complete dark glassmorphism shopping UI with approval dashboard and audit viewer.

**Pages:**

| Route | Purpose |
|-------|---------|
| `/` | Landing page with hero + featured products |
| `/(shop)/products` | Product catalog with search, filters |
| `/(shop)/products/[id]` | Product detail with agent negotiation status |
| `/(shop)/cart` | Cart with total, agent recommendations |
| `/(shop)/checkout` | Checkout with wallet connect + agent routing |
| `/(dashboard)/approvals` | Pending approvals queue with real-time updates |
| `/(dashboard)/audit` | Visual agent action timeline |

**Key Components:**

| Component | Purpose |
|-----------|---------|
| `ProductCard` | Product card with agent discount badge |
| `ApprovalCard` | Rich card (product, supplier rep, price, risk) |
| `AgentTracePanel` | Live reasoning steps via WebSocket |
| `WalletConnect` | Wallet connection UI |
| `DecisionTimeline` | Step-by-step agent action timeline |
| `TransactionTrail` | Audit chain viewer |
| `SignatureVerifier` | On-chain signature verification display |

**Design System:**
- **Palette:** Deep navy `#0B1426` → Electric blue `#3B82F6` → Emerald `#10B981`
- **Typography:** Inter (headings) + JetBrains Mono (code/prices)
- **Effects:** Glassmorphism cards, gradient borders, micro-animations
- **Theme:** Dark mode default with light mode toggle

**Verify:** `npm run build` → zero errors. Navigate full shopping flow in browser.

---

### Phase 7 — Integration, Dockerization & Polish

**Goal:** End-to-end demo-ready application, single `docker compose up` startup.

| Deliverable | Detail |
|-------------|--------|
| Full E2E wiring | frontend → backend → agents → governance → contracts |
| `docker-compose.yml` | Services: `backend`, `frontend`, `postgres`, `redis` |
| Documentation | `README.md`, `docs/ARCHITECTURE.md`, `docs/AGENT_DESIGN.md`, `docs/API.md` |
| Error handling | Graceful failures, retries, edge cases |
| Performance | SSE streaming for agent progress, Redis caching |

**Full Demo Flows:**
1. **Routine purchase** (< ₹5,000): query → agents → auto-settle → audit
2. **High-value purchase** (≥ ₹5,000): query → agents → human approval → settle → audit
3. **Dispute flow**: buyer raises dispute → human mediation → refund → reputation updated

**Verify:** `docker compose up --build` starts full stack. All 3 flows complete successfully.

---

## Verification Summary

| Phase | Test |
|-------|------|
| 1 | OpenAPI docs at `/docs`, models create in DB |
| 2 | `POST /api/agent/query` returns structured plan |
| 3 | High-value query triggers WebSocket approval |
| 4 | Agent actions have valid HMAC signatures in DB |
| 5 | `npx hardhat test` passes for all 4 contracts |
| 6 | Frontend shows all pages with dark glass UI |
| 7 | `docker compose up` → full E2E flow works |

> [!IMPORTANT]
> Each phase is executed **one at a time**. After each phase the user confirms before the next phase begins.

> [!WARNING]
> **LLM API Key Required:** The Discovery and Negotiation agents use an LLM. You'll need to provide an API key (Gemini / OpenAI / local Ollama) in `.env`.
